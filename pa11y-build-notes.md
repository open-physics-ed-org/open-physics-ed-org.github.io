# Pa11y Build Integration Plan (Verbose)

## Overview
This document describes the plan for integrating Pa11y accessibility checks into the site build process, including badge injection, report generation, configuration, and CLI usage. The goal is to ensure every HTML page (including autogenerated and top-level) is checked for accessibility, with results clearly surfaced and actionable for users and developers.

---

## 1. Badge/Button Placement & Accessibility
- **Where:**
  - The accessibility badge/button will be injected into each built HTML file in `build/`.
  - It will be placed immediately after the opening `<main>` tag. If `<main>` is not found, fallback to after `<body>`.
- **How:**
  - The badge/button will be fully WCAG/ARIA compliant, using `role="button"`, `aria-label`, visible focus, and other best practices.
  - The badge will link to a detailed accessibility report for that file.

---

## 2. Report Generation
- **Where:**
  - Each report will be named `wcag_report_<basename>.html` and placed in the same directory as the HTML file it describes.
- **How:**
  - Reports will be generated using a dedicated Jinja2 template (e.g., `layouts/_default/wcag_report.html`), extending the site's base layout for consistent styling.
  - The report will include all issues found by Pa11y, summary statistics, and the badge.

---

## 3. WCAG Logos and Config
- **Source:**
  - The primary source for logo info is `pa11y-configs/wcag_logos.json`.
  - If `_content.yml` contains a `pa11y:` section with logo overrides, those take precedence.
  - If neither is present, a warning is logged and a default/fallback logo is used.
- **Usage:**
  - The badge and report will use the logo and alt text from the config.

---

## 4. Database and Logging
- **DB Usage:**
  - The SQL database is used to determine which files to process (using the `content` table and its `output_path`).
  - Results are stored in the `accessibility_results` table, linked by `content_id`.
- **Logging:**
  - All errors and issues are logged to `log/pa11y.log`, which is overwritten on each run.
  - Any file not found in the DB, or any other issue, is logged for debugging.

---

## 5. Copying to docs/
- **When:**
  - Copying from `build/` to `docs/` is a separate, explicit step, not automatic.
  - This allows for review and debugging before publishing.

---

## 6. CLI Usage
- **Modes:**
  - The script supports both single-file and batch mode.
- **Flags:**
  - `--file <path>`: Check a single file.
  - `--all`: Check all files in the DB.
  - `--log-level <level>`: Set log verbosity (info/debug/warning).
  - `--report-only`: Only generate reports, do not run Pa11y.
  - `--inject-only`: Only inject badges, do not run Pa11y or generate reports.
  - `--copy-to-docs`: Copy changed files to `docs/` after processing.
  - `--dry-run`: Show what would be done, but make no changes.
  - `--skip-autobuilt`: Optionally skip autogenerated pages.
- **Behavior:**
  - The script continues on errors, logging all issues for later review.

---

## 7. Error Handling
- **Robustness:**
  - The script continues processing other files even if errors occur for a particular file.
  - All errors and issues are logged for debugging.

---

## 8. Module/Path Awareness
- **Structure:**
  - All code is in `project_root/oerforge/`.
  - Build output is in `project_root/build/`.
  - Reports and badges are generated in `build/` and later copied to `docs/` as needed.

---

## 9. Accessibility First
- **Principle:**
  - All injected UI (badges, buttons, reports) will be designed for maximum accessibility, following WCAG and ARIA best practices.

---

## 10. Future Considerations
- **Extensibility:**
  - The system is designed to be extensible for future CLI flags, new report types, or integration with CI/CD.
- **Documentation:**
  - This plan and all implementation details will be documented for maintainers and contributors.

---

*End of plan.*
